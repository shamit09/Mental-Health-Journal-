<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Journal Feed — অন্তরJATRA</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="journal-page">

  <nav>
    <div class="container">
      <a href="landing.html" class="logo">অন্তরJATRA</a>
      <div class="nav-links">
        <a href="landing.html">Home</a>
        <a href="journal.html" class="active">Journal</a>
        <a href="chat.html">Chat</a>
        <a href="consultant.html">Consultants</a>
      </div>
      <div class="nav-buttons">
        <a href="login.html" class="btn">Login</a>
        <a href="login.html" class="btn primary">Sign Up</a>
      </div>
    </div>
  </nav>

  <main>
    <h1>Community Journals</h1>
    <div class="card-grid">
      <article class="card">
        <div class="card-content">
          <h2>Finding Peace in Stillness</h2>
          <p>"Today, I sat by the window and watched the rain. It felt like the world paused with me, offering a moment of calm amidst the chaos..."</p>
        </div>
        <div class="card-footer">
          <span>By Anonymous • <time datetime="2025-07-19">Jul 19, 2025</time></span>
          <a href="#" class="read-more">Read More</a>
        </div>
        <div class="comments">
          <h3>Comments</h3>
          <ul>
            <li><strong>User123:</strong> What a beautiful reflection.</li>
          </ul>
          <textarea placeholder="Add a comment..."></textarea>
          <button>Post Comment</button>
        </div>
      </article>
      <!-- repeat more cards as needed -->
    </div>
  </main>

  <footer>
    <p>© 2025 অন্তরJATRA. All rights reserved.</p>
  </footer>

  <script>
    function getSessionUser() {
      try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch(e){ return null; }
    }

    async function readJson(res) {
      const text = await res.text();
      return text ? JSON.parse(text) : null;
    }

    async function fetchJournals() {
      const res = await fetch('/api/journals');
      const data = await readJson(res);
      if (!res.ok) throw new Error((data && data.error) || 'Failed to load journals');
      return (data && data.items) || [];
    }

    async function fetchComments(journalId) {
      const res = await fetch(`/api/journals/${journalId}/comments`);
      const data = await readJson(res);
      if (!res.ok) throw new Error((data && data.error) || 'Failed to load comments');
      return (data && data.items) || [];
    }

    async function postComment(journalId, content) {
      const user = getSessionUser();
      if (!user) { alert('Please login first.'); window.location.href = 'login.html'; return; }
      const res = await fetch(`/api/journals/${journalId}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: user.id, content })
      });
      if (!res.ok) {
        const err = await readJson(res);
        throw new Error((err && err.error) || 'Failed to post comment');
      }
    }

    function createJournalCard(item) {
      const article = document.createElement('article');
      article.className = 'card';
      article.innerHTML = `
        <div class="card-content">
          <h2></h2>
          <p></p>
        </div>
        <div class="card-footer">
          <span></span>
          <a href="#" class="read-more">Read More</a>
        </div>
        <div class="comments">
          <h3>Comments</h3>
          <ul class="comments-list"></ul>
          <textarea placeholder="Add a comment..."></textarea>
          <button>Post Comment</button>
        </div>
      `;
      article.querySelector('h2').textContent = item.title;
      article.querySelector('p').textContent = item.content;
      article.querySelector('span').textContent = `By ${item.author} • ${new Date(item.created_at).toLocaleDateString()}`;
      const listEl = article.querySelector('.comments-list');
      fetchComments(item.id).then(comments => {
        comments.forEach(c => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${c.author}:</strong> ${c.content}`;
          listEl.appendChild(li);
        });
      }).catch(err => {
        const li = document.createElement('li');
        li.textContent = 'Failed to load comments';
        listEl.appendChild(li);
      });
      const btn = article.querySelector('button');
      const textarea = article.querySelector('textarea');
      btn.addEventListener('click', async () => {
        const content = textarea.value.trim();
        if (!content) return;
        try {
          await postComment(item.id, content);
          const li = document.createElement('li');
          const user = getSessionUser();
          li.innerHTML = `<strong>${user.name}:</strong> ${content}`;
          listEl.appendChild(li);
          textarea.value = '';
        } catch (e) { alert(e.message); }
      });
      return article;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const grid = document.querySelector('.card-grid');
      grid.innerHTML = '';
      try {
        const journals = await fetchJournals();
        if (!journals.length) {
          const p = document.createElement('p');
          p.textContent = 'No journals yet.';
          grid.appendChild(p);
        } else {
          journals.forEach(j => grid.appendChild(createJournalCard(j)));
        }
      } catch (e) {
        const p = document.createElement('p');
        p.textContent = 'Failed to load journals';
        grid.appendChild(p);
      }
    });
  </script>

</body>
</html>
